# 基于角色的权限访问控制（RBAC）
> 用户都属于角色 
>
> 只给角色分配权限 
>
> 用户与角色是N对N关系
>
> 角色与权限是N对N关系  

## 一、数据库设计

### 用户表

### 角色表

### 权限表

### 用户角色关联表

### 角色权限关联表

## 二、前端页面级权限控制
 	单页面应用前端会有自己的前端路由，一般角色类型较少并且角色总数可预期时，会采用在前端路由表中加入该路由项的权重值（数字或角色名），实现页面的权限管理。  
```javascript
// router.js
{
  name: '表单页',

  icon: 'form',

  path: 'form',

  children: [{

    name: '基础表单',

    path: 'basic-form',

  }, {

    name: '高级表单',

    authority: ['admin'], // 配置准入权限

    path: 'advanced-form',

  }]
}

// permission.js
router.beforeEach((to, from, next) => {
  // 需要判断权限的路由
  if (to.authority !== undefined) { 
    if (to.authority.indexOf(user.authority) > -1 ) {
      next()
    } else {
      next({
        replace: true,
        name: 'error-403'
      });
    }
  } else { // 没有配置权限的路由, 直接通过
    next()
  }
}
```
​	这种方法常见于主流的技术栈的管理系统类脚手架中，例如react的antd，vue的vue-element-admin。这种方法虽然做到了菜单的权限控制，满足了不同用户进入不同菜单，但体验和隐私上不好，所有人都能在代码中看到所有的菜单项，所以为了能看上去更安全，决定采用更合理的方法。

​	目前的需求是系统中角色可以动态添加删除，每个角色的菜单权限均靠动态配置，综合之前的隐私考虑前端将不再提供路由表为每个路由赋予权限，而是通过接口返回的路由数据动态生成菜单显示。

​	用户在登录成功后，调用用户权限接口获取用户可访问权限的路由表信息。前端通过`router.addRoutes`动态挂载路由。并使用vuex（redux）管理路由表并渲染到侧边栏组件。

## 三、后端页面级权限控制
​	Node对每一个需要页面级权限的API接口添加权限校验中间件，通过请求头中的路由地址与数据库中根据用户id查询到的菜单路由匹配，如果匹配成功，那么权限校验成功，否则返回403-权限不足的错误信息。  